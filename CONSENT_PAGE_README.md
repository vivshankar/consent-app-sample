# Consent Page Feature

This document describes the new consent page feature added to the consent-app-sample application.

## Overview

The consent page is a standalone, client-side web interface that allows users to review and approve/deny permissions (scopes) requested by an application. The page is fully self-contained with all logic implemented in HTML and JavaScript.

## How It Works

1. **JWT Token**: The consent page receives a JWT token via the `consent_jwt` query parameter
2. **Scope Extraction**: The JWT contains a `scope` attribute (array of permission strings)
3. **User Interface**: The page displays checkboxes for each scope, allowing users to approve/deny individually
4. **Response Submission**: When submitted, user choices are converted to a JSON object and POSTed to a target URL

## Endpoint

```
GET /consent?consent_jwt=<JWT_TOKEN>&target=<TARGET_URL>
```

### Query Parameters

| Parameter | Required | Description |
|-----------|----------|-------------|
| `consent_jwt` | Yes | JWT token containing the `scope` array |
| `target` | Yes | URL where the user response will be POSTed |

## JWT Format

The `consent_jwt` must be a valid JWT token with the following payload structure:

```json
{
  "scope": [
    "read:profile",
    "write:profile",
    "read:email",
    "access:location"
  ],
  "iat": 1234567890,
  "exp": 1234571490
}
```

### Required Fields

- `scope` (array): List of permission strings to request from the user

## User Response Format

When the user submits the form, a `user_response` form parameter is POSTed to the target URL:

```
POST <target_url>
Content-Type: application/x-www-form-urlencoded

user_response={"read:profile":true,"write:profile":true,"read:email":false,"access:location":true}
```

The `user_response` is a JSON string where:
- **Key**: The scope value shown to the user
- **Value**: `true` if approved, `false` if denied

## Example Usage

### 1. Generate a JWT Token

```javascript
const jwt = require('jsonwebtoken');

const payload = {
  scope: ['read:profile', 'write:profile', 'read:email'],
  iat: Math.floor(Date.now() / 1000),
  exp: Math.floor(Date.now() / 1000) + 3600
};

const token = jwt.sign(payload, 'your-secret-key');
```

### 2. Build the Consent Page URL

```javascript
const consentPageURL = new URL('http://localhost:3000/consent');
consentPageURL.searchParams.set('consent_jwt', token);
consentPageURL.searchParams.set('target', 'https://your-app.com/receive-consent');

console.log(consentPageURL.toString());
// http://localhost:3000/consent?consent_jwt=eyJhbG...&target=https%3A%2F%2Fyour-app.com%2Freceive-consent
```

### 3. Redirect User to Consent Page

```javascript
// In your application
res.redirect(consentPageURL.toString());
```

### 4. Handle the Response

```javascript
// Endpoint to receive consent response
app.post('/receive-consent', (req, res) => {
  const userResponse = JSON.parse(req.body.user_response);
  
  console.log('User consent choices:', userResponse);
  // {
  //   "read:profile": true,
  //   "write:profile": true,
  //   "read:email": false
  // }
  
  // Process the consent choices...
  res.send('Consent received!');
});
```

## Testing

A test script is provided to demonstrate the consent page functionality:

```bash
# Install dependencies first
npm install

# Start the main application (in one terminal)
npm start

# Run the test script (in another terminal)
node test-consent-page.js
```

The test script will:
1. Start a test server on port 3001 to receive consent responses
2. Generate a sample JWT token with example scopes
3. Display a consent page URL you can open in your browser
4. Show the received consent response when you submit the form

## Files Added

- `src/controllers/consentPageController.js` - Controller that serves the consent page
- `src/routes/consentPage.js` - Route definition for `/consent`
- `src/views/consent.html` - Static HTML page with client-side logic
- `test-consent-page.js` - Test script to demonstrate usage

## Security Considerations

### Current Implementation (Demo)

The current implementation decodes the JWT **without verification** for demonstration purposes. This is suitable for:
- Development and testing
- Internal applications where the JWT is generated by a trusted source
- Scenarios where JWT verification happens elsewhere in your flow

### Production Recommendations

For production use, you should:

1. **Verify JWT Signature**: Add server-side JWT verification before serving the page
2. **Validate Claims**: Check `exp`, `iat`, and other claims
3. **Use HTTPS**: Always use HTTPS in production
4. **CSRF Protection**: Implement CSRF tokens if needed
5. **Rate Limiting**: Add rate limiting to prevent abuse

Example server-side verification:

```javascript
const jwt = require('jsonwebtoken');

const showConsentPage = (req, res, next) => {
  try {
    const { consent_jwt, target } = req.query;
    
    // Verify the JWT signature
    const decoded = jwt.verify(consent_jwt, process.env.JWT_SECRET);
    
    // Validate the decoded token
    if (!decoded.scope || !Array.isArray(decoded.scope)) {
      throw new Error('Invalid scope in JWT');
    }
    
    // Serve the page
    res.sendFile(path.join(__dirname, '../views/consent.html'));
  } catch (err) {
    next(err);
  }
};
```

## UI Features

- **Modern Design**: Clean, responsive interface with gradient background
- **Interactive Checkboxes**: Each scope can be individually approved/denied
- **Bulk Actions**: "Deny All" button to quickly reject all permissions
- **Error Handling**: Clear error messages for invalid parameters
- **Loading State**: Shows loading spinner during form submission
- **Auto-Submit**: Automatically POSTs to target URL after user confirmation

## Browser Compatibility

The consent page uses modern JavaScript features and should work in:
- Chrome/Edge 90+
- Firefox 88+
- Safari 14+
- Opera 76+

## Customization

### Styling

To customize the appearance, edit the `<style>` section in `src/views/consent.html`:

```css
/* Change the gradient background */
body {
  background: linear-gradient(135deg, #your-color1 0%, #your-color2 100%);
}

/* Change button colors */
.btn-approve {
  background: linear-gradient(135deg, #your-color1 0%, #your-color2 100%);
}
```

### Scope Display

To customize how scopes are displayed, modify the `renderScopes()` function in the JavaScript section.

## Troubleshooting

### "Missing consent_jwt parameter"
- Ensure the URL includes the `consent_jwt` query parameter
- Check that the JWT token is properly URL-encoded

### "Invalid JWT format"
- Verify the JWT token is valid and properly formatted
- Check that the token hasn't expired

### "Missing target parameter"
- Ensure the URL includes the `target` query parameter
- Verify the target URL is properly URL-encoded

### Form doesn't submit
- Check browser console for JavaScript errors
- Verify the target URL is accessible
- Ensure CORS is properly configured if target is on a different domain

## License

This feature is part of the consent-app-sample project and follows the same license.

---

Made with Bob